const request = require('request');
const getYoutubeID = require('get-youtube-id');
const fetchVideoInfo = require('youtube-info');

const yt_api_key = "AIzaSyDeoIH0u1e72AtfpwSKKOSy3IPp2UHzqi4";
const discord_token = "NDYwMTU0MjQyNTE5NDAwNDQ4.DkjS2g.RNf1k6CoUDF3ThHy4b1YWVepXQg";
client.login(discord_token);
client.on('ready', function() {
    console.log(`i am ready ${client.user.username}`);
});
/*
////////////////////////\\\\\\\\\\\\\\\\\\\\\\\\\
////////////////////////\\\\\\\\\\\\\\\\\\\\\\\\\
////////////////////////\\\\\\\\\\\\\\\\\\\\\\\\\
////////////////////////\\\\\\\\\\\\\\\\\\\\\\\\\
*/
var servers = [];
var queue = [];
var guilds = [];
var queueNames = [];
var isPlaying = false;
var dispatcher = null;
var voiceChannel = null;
var skipReq = 0;
var skippers = [];
var now_playing = [];
/*
\\\\\\\\\\\\\\\\\\\\\\\\V/////////////////////////
\\\\\\\\\\\\\\\\\\\\\\\\V/////////////////////////
\\\\\\\\\\\\\\\\\\\\\\\\V/////////////////////////
\\\\\\\\\\\\\\\\\\\\\\\\V/////////////////////////
*/
client.on('ready', () => {});
var download = function(uri, filename, callback) {
    request.head(uri, function(err, res, body) {
        console.log('content-type:', res.headers['content-type']);
        console.log('content-length:', res.headers['content-length']);

        request(uri).pipe(fs.createWriteStream(filename)).on('close', callback);
    });
};

client.on('message', function(message) {
    const member = message.member;
    const mess = message.content.toLowerCase();
    const args = message.content.split(' ').slice(1).join(' ');

    if (mess.startsWith(prefix + 'play')) {
	        if(!message.channel.guild) return message.reply(' ');
        if (!message.member.voiceChannel) return message.channel.send(':no_entry: || **__ÌÃ» «‰  ﬂÊ‰ ›Ì —Ê„ ’Ê Ì__**');
        // if user is not insert the URL or song title
        if (args.length == 0) {
            let play_info = new Discord.RichEmbed()
                .setAuthor(client.user.username, client.user.avatarURL)
                .setFooter('ÿ·» »Ê«”ÿ…: ' + message.author.tag)
                .setDescription('**ﬁ„ »≈œ—«Ã —«»ÿ «Ê «”„ «·√€‰ÌÂ**')
            message.channel.sendEmbed(play_info)
            return;
        }
        if (queue.length > 0 || isPlaying) {
            getID(args, function(id) {
                add_to_queue(id);
                fetchVideoInfo(id, function(err, videoInfo) {
                    if (err) throw new Error(err);
                    let play_info = new Discord.RichEmbed()
                        .setAuthor(client.user.username, client.user.avatarURL)
                        .addField(' „  ≈÷«›…«·«€‰ÌÂ »ﬁ«∆„… «·≈‰ Ÿ«—', `**
                          ${videoInfo.title}
                          **`)
                        .setColor("#a637f9")
                        .setFooter('|| ' + message.author.tag)
                        .setThumbnail(videoInfo.thumbnailUrl)
                    message.channel.sendEmbed(play_info);
                    queueNames.push(videoInfo.title);
                    now_playing.push(videoInfo.title);

                });
            });
        }
        else {

            isPlaying = true;
            getID(args, function(id) {
                queue.push('placeholder');
                playMusic(id, message);
                fetchVideoInfo(id, function(err, videoInfo) {
                    if (err) throw new Error(err);
                    let play_info = new Discord.RichEmbed()
                        .setAuthor(client.user.username, client.user.avatarURL)
                        .addField('__** „ «· ‘€Ì· ?**__', `**${videoInfo.title}
                              **`)
                        .setColor("RANDOM")
                        .addField(`»Ê«”ÿÂ`, message.author.username)
                        .setThumbnail(videoInfo.thumbnailUrl)

                    // .setDescription('?')
                    message.channel.sendEmbed(play_info)
                    message.channel.send(`
                            **${videoInfo.title}**  „  ‘€Ì· `)
                    // client.user.setGame(videoInfo.title,'https://www.twitch.tv/Abdulmohsen');
                });
            });
        }
    }
    else if (mess.startsWith(prefix + 'skip')) {
	        if(!message.channel.guild) return message.reply(' ');
        if (!message.member.voiceChannel) return message.channel.send(':no_entry: || **__ÌÃ» «‰  ﬂÊ‰ ›Ì —Ê„ ’Ê Ì__**');
        message.channel.send('`?`').then(() => {
            skip_song(message);
            var server = server = servers[message.guild.id];
            if (message.guild.voiceConnection) message.guild.voiceConnection.disconnect();
        });
    }
    else if (message.content.startsWith(prefix + 'vol')) {
	        if(!message.channel.guild) return message.reply(' ');
        if (!message.member.voiceChannel) return message.channel.send(':no_entry: || **__ÌÃ» «‰  ﬂÊ‰ ›Ì —Ê„ ’Ê Ì__**');
        // console.log(args)
        if (args > 100) return message.channel.send('1 - 100 || **__·« √ﬂÀ— Ê·« √ﬁ·__**')
        if (args < 1) return message.channel.send('1 - 100 || **__·« √ﬂÀ— Ê·« √ﬁ·__**')
        dispatcher.setVolume(1 * args / 50);
        message.channel.sendMessage(`**__ ${dispatcher.volume*50}% „” ÊÏ «·’Ê  __**`);
    }
    else if (mess.startsWith(prefix + 'pause')) {
	        if(!message.channel.guild) return message.reply(' ');
        if (!message.member.voiceChannel) return message.channel.send(':no_entry: || **__ÌÃ» «‰  ﬂÊ‰ ›Ì —Ê„ ’Ê Ì__**');
        message.channel.send('`?`').then(() => {
            dispatcher.pause();
        });
    }
    else if (mess.startsWith(prefix + 'ok')) {
	        if(!message.channel.guild) return message.reply(' ');
        if (!message.member.voiceChannel) return message.channel.send(':no_entry: || **__ÌÃ» «‰  ﬂÊ‰ ›Ì —Ê„ ’Ê Ì__**');
            message.channel.send('`?`').then(() => {
            dispatcher.resume();
        });
    }
    else if (mess.startsWith(prefix + 'stop')) {
	        if(!message.channel.guild) return message.reply(' ');
        if (!message.member.voiceChannel) return message.channel.send(':no_entry: || **__ÌÃ» «‰  ﬂÊ‰ ›Ì —Ê„ ’Ê Ì__**');
        message.channel.send('`?`');
        var server = server = servers[message.guild.id];
        if (message.guild.voiceConnection) message.guild.voiceConnection.disconnect();
    }
    else if (mess.startsWith(prefix + 'come')) {
	        if(!message.channel.guild) return message.reply(' ');
        if (!message.member.voiceChannel) return message.channel.send(':no_entry: || **__ÌÃ» «‰  ﬂÊ‰ ›Ì —Ê„ ’Ê Ì__**');
        message.member.voiceChannel.join().then(message.channel.send(':ok:'));
    }
    else if (mess.startsWith(prefix + 'play')) {
	        if(!message.channel.guild) return message.reply(' ');
        if (!message.member.voiceChannel) return message.channel.send(':no_entry: || **__ÌÃ» «‰  ﬂÊ‰ ›Ì —Ê„ ’Ê Ì__**');
        if (isPlaying == false) return message.channel.send(':anger: || **__ „ «· ÊﬁÌ›__**');
        let playing_now_info = new Discord.RichEmbed()
            .setAuthor(client.user.username, client.user.avatarURL)
            .addField(' „  ≈÷«›…«·«€‰ÌÂ »ﬁ«∆„… «·≈‰ Ÿ«—', `**
                  ${videoInfo.title}
                  **`)
            .setColor("RANDOM")
            .setFooter('ÿ·» »Ê«”ÿ…: ' + message.author.tag)
            .setThumbnail(videoInfo.thumbnailUrl)
        //.setDescription('?')
        message.channel.sendEmbed(playing_now_info);
    }
});

function skip_song(message) {
    if (!message.member.voiceChannel) return message.channel.send(':no_entry: || **__ÌÃ» «‰  ﬂÊ‰ ›Ì —Ê„ ’Ê Ì__**');
    dispatcher.end();
}

function playMusic(id, message) {
    voiceChannel = message.member.voiceChannel;


    voiceChannel.join().then(function(connectoin) {
        let stream = ytdl('https://www.youtube.com/watch?v=' + id, {
            filter: 'audioonly'
        });
        skipReq = 0;
        skippers = [];

        dispatcher = connectoin.playStream(stream);
        dispatcher.on('end', function() {
            skipReq = 0;
            skippers = [];
            queue.shift();
            queueNames.shift();
            if (queue.length === 0) {
                queue = [];
                queueNames = [];
                isPlaying = false;
            }
            else {
                setTimeout(function() {
                    playMusic(queue[0], message);
                }, 500);
            }
        });
    });
}

function getID(str, cb) {
    if (isYoutube(str)) {
        cb(getYoutubeID(str));
    }
    else {
        search_video(str, function(id) {
            cb(id);
        });
    }
}

function add_to_queue(strID) {
    if (isYoutube(strID)) {
        queue.push(getYoutubeID(strID));
    }
    else {
        queue.push(strID);
    }
}

function search_video(query, cb) {
    request("https://www.googleapis.com/youtube/v3/search?part=id&type=video&q=" + encodeURIComponent(query) + "&key=" + yt_api_key, function(error, response, body) {
        var json = JSON.parse(body);
        cb(json.items[0].id.videoId);
    });
}


function isYoutube(str) {
    return str.toLowerCase().indexOf('youtube.com') > -1;
}
 client.on('message', message => {
     if (message.content === prefix +"hhelp") {
    const embed = new Discord.RichEmbed()
     .setColor("RANDOM")
     .addField(`Zyad,aLmutairi commands:

+about - shows info about the bot
+ping - checks the bot's latency

  Music:

+play - shows the song that is currently playing
+play <title|URL|subcommand> - plays the provided song
+queue [pagenum] - shows the current queue
+ ⁄«· <title|URL|subcommand> - plays the provided song
+skip - votes to skip the current song

  DJ:
+ok <title|URL|subcommand> - plays the provided song
+skip - skips the current song
+pause - pauses the current song
+skipt <position> - skips to the specified song
+stop - stops the current song and clears the queue
+vol [0-150] - sets or shows volume

For additional help,  `)

      message.channel.send({embed});
     }
    });
	client.on('message', message => {
let prefix = "1";
    if (message.content.startsWith(prefix + "about")) {
	        if(!message.channel.guild) return message.reply(' ');
 let embed = new Discord.RichEmbed() 
    .setColor('RED')
    .addField('**«·–«ﬂ—… «·„” Œœ„… ??**', `${(process.memoryUsage().rss / 1000000).toFixed()}MB`, true)
        .addField('**”—⁄… «·« ’«·??**' , `${Date.now() - message.createdTimestamp}` + ' ms')
        .addField('**Êﬁ  «·«ﬁ·«⁄?**', (process.uptime()), true)
        .addField('**«” Œœ«„ «·„⁄«·Ã??**', `${(process.cpuUsage().rss / 10000).toFixed()}%`, true)
	message.channel.send(embed);
    }//h·»Ê  ÌﬁÊ· «‰Â «·„”Ã ›«÷Ì 
  });
  client.on('message', message => {
                                if(!message.channel.guild) return;
                        if (message.content.startsWith('hping')) {
                            if(!message.channel.guild) return;
                            var msg = `${Date.now() - message.createdTimestamp}`
                            var api = `${Math.round(client.ping)}`
                            if (message.author.bot) return;
                        let embed = new Discord.RichEmbed()
                        .setAuthor(message.author.username,message.author.avatarURL)
                        .setColor('RANDOM')
                        .addField('**Time Taken:**',msg + " ms ?? ")
                        .addField('**WebSocket:**',api + " ms ?? ")
         message.channel.send({embed:embed});
                        }
                    });